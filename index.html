<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Enhanced Dashboard</title>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Dark Theme */
            --bg-gradient-dark: linear-gradient(135deg, #000000, #4d0000, #2a0000, #000000);
            --primary-color-dark: #ff0000; --text-color-dark: #ffffff; --bg-color-dark: #000000;
            --shadow-color-dark: #ff0000; --button-bg-dark: #000000; --button-text-dark: #ffffff;
            --input-bg-dark: #1a1a1a; --input-border-dark: #ff0000; --sidebar-bg-dark: #101010;
            --sidebar-border-dark: #444; --link-color-dark: #ff7b7b; --popup-bg-dark: #252525;
            --popup-border-dark: var(--primary-color-dark);

            /* Light Theme */
            --bg-gradient-light: linear-gradient(135deg, #e0e0e0, #ffffff, #dadaff, #ffffff);
            --primary-color-light: #007bff; --text-color-light: #333333; --bg-color-light: #ffffff;
            --shadow-color-light: rgba(0, 123, 255, 0.5); --button-bg-light: #f0f0f0; --button-text-light: #333333;
            --input-bg-light: #ffffff; --input-border-light: #cccccc; --sidebar-bg-light: #f8f9fa;
            --sidebar-border-light: #dee2e6; --link-color-light: #0056b3; --popup-bg-light: #ffffff;
            --popup-border-light: var(--primary-color-light);

            --cursor-color: darkgreen; --transition-speed: 0.3s; --neon-blur: 8px;
            --neon-blur-hover: 16px; --sidebar-width: 280px;
        }

        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        body {
            margin: 0; font-family: 'Consolas', 'Monaco', monospace; overflow: hidden;
            transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
            cursor: none; min-height: 100vh; background-size: 300% 300%; animation: gradientAnimation 18s ease infinite;
        }
        body.dark-theme {
            background: var(--bg-gradient-dark); color: var(--text-color-dark);
            --primary-color: var(--primary-color-dark); --text-color: var(--text-color-dark); --bg-color: var(--bg-color-dark);
            --shadow-color: var(--shadow-color-dark); --button-bg: var(--button-bg-dark); --button-text: var(--button-text-dark);
            --input-bg: var(--input-bg-dark); --input-border: var(--input-border-dark); --sidebar-bg: var(--sidebar-bg-dark);
            --sidebar-border: var(--sidebar-border-dark); --link-color: var(--link-color-dark); --popup-bg: var(--popup-bg-dark);
            --popup-border: var(--popup-border-dark); --neon-blur-current: var(--neon-blur); --neon-blur-hover-current: var(--neon-blur-hover);
        }
        body.light-theme {
            background: var(--bg-gradient-light); color: var(--text-color-light);
            --primary-color: var(--primary-color-light); --text-color: var(--text-color-light); --bg-color: var(--bg-color-light);
            --shadow-color: var(--shadow-color-light); --button-bg: var(--button-bg-light); --button-text: var(--button-text-light);
            --input-bg: var(--input-bg-light); --input-border: var(--input-border-light); --sidebar-bg: var(--sidebar-bg-light);
            --sidebar-border: var(--sidebar-border-light); --link-color: var(--link-color-light); --popup-bg: var(--popup-bg-light);
            --popup-border: var(--popup-border-light); --neon-blur-current: 3px; --neon-blur-hover-current: 6px;
        }

        /* Tab Navigation */
        .tabs {
            position: fixed; top: 15px; left: 15px; z-index: 1000; display: flex; flex-wrap: wrap; gap: 8px;
            background-color: rgba(0, 0, 0, 0.3); padding: 5px; border-radius: 10px; max-width: calc(100% - var(--sidebar-width) - 40px);
        }
        .tab-button {
            padding: 10px 18px; border: 1px solid transparent; background: var(--button-bg); color: var(--button-text);
            box-shadow: 0 0 var(--neon-blur-current) var(--shadow-color); border-radius: 8px; cursor: pointer;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease, background-color var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease;
            font-family: inherit; font-size: 0.9em;
        }
        .tab-button:hover, .tab-button.active { box-shadow: 0 0 var(--neon-blur-hover-current) var(--shadow-color); transform: translateY(-2px) scale(1.03); border-color: var(--primary-color); }
        .tab-button.active { background-color: var(--primary-color); color: var(--bg-color); font-weight: bold; }

        /* Tab Content Area */
        main { padding: 90px 30px 30px; padding-right: calc(var(--sidebar-width) + 40px); height: calc(100vh - 120px); overflow-y: auto; box-sizing: border-box; }
        .tab-content { display: none; animation: fadeIn 0.5s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* General Button Styling (Neon) */
        .neon-btn {
            background: var(--button-bg); border: 2px solid var(--primary-color); color: var(--button-text);
            padding: 12px 25px; font-size: 1.0em; border-radius: 10px;
            box-shadow: 0 0 var(--neon-blur-current) var(--shadow-color), inset 0 0 5px rgba(var(--primary-color-rgb, 255, 0, 0), 0.3);
            cursor: pointer; margin: 8px 5px;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease, background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            font-family: inherit; text-decoration: none; display: inline-block; vertical-align: middle;
        }
        .neon-btn:hover { box-shadow: 0 0 var(--neon-blur-hover-current) var(--shadow-color), inset 0 0 10px rgba(var(--primary-color-rgb, 255, 0, 0), 0.5); transform: scale(1.05); background-color: var(--primary-color); color: var(--bg-color); }
        .neon-btn:active { transform: scale(0.98); }

        /* Custom Cursor (Dark Green) */
        .crosshair { position: fixed; width: 18px; height: 18px; transform: translate(-50%, -50%); pointer-events: none; z-index: 2100; opacity: 0; transition: opacity 0.1s ease; }
        body:hover .crosshair { opacity: 1; }
        .crosshair::before, .crosshair::after { content: ''; position: absolute; background-color: var(--cursor-color); }
        .crosshair::before { left: 50%; top: 0; width: 2px; height: 100%; transform: translateX(-50%); }
        .crosshair::after { top: 50%; left: 0; width: 100%; height: 2px; transform: translateY(-50%); }

        /* Iframe Styling */
        iframe { width: calc(100% - 4px); height: 70vh; border: 2px solid var(--primary-color); filter: drop-shadow(0 0 10px var(--shadow-color)); transition: border-color var(--transition-speed) ease, filter var(--transition-speed) ease; background-color: var(--bg-color); margin-top: 10px; }

        /* Input Fields */
        input[type="text"], input[type="search"], select, textarea { background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-color); padding: 8px 10px; margin-bottom: 10px; border-radius: 5px; font-family: inherit; font-size: 0.9em; width: 100%; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease, color var(--transition-speed) ease; box-sizing: border-box; }
        input[type="text"]:focus, input[type="search"]:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 8px var(--shadow-color); }

        /* Pastebin Specific */
        #pastebin-list-container { max-height: 40vh; overflow-y: auto; padding: 10px; border: 1px solid var(--input-border); border-radius: 5px; margin-top: 10px; background-color: rgba(0,0,0,0.1); text-align: center; }
        #pastebin-list .neon-btn { display: inline-block; width: fit-content; min-width: 200px; max-width: 90%; margin: 5px; margin-bottom: 8px; text-align: left; padding-left: 15px; padding-right: 15px; box-sizing: border-box; }
        #pastebin-content { white-space: pre-wrap; background: var(--input-bg); padding: 15px; border: 1px solid var(--input-border); box-shadow: 0 0 10px var(--shadow-color); color: var(--text-color); max-height: 55vh; overflow-y: auto; border-radius: 5px; margin-bottom: 15px; transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        #pastebin-view { display: none; }

        /* Class List Specific */
        #class-list .neon-btn { /* Renamed class for clarity */
            display: block; width: fit-content; min-width: 180px; margin-bottom: 10px;
            margin-left: auto; margin-right: auto; text-align: center; padding-left: 15px; padding-right: 15px;
        }
        .link-btn { margin-top: 15px; display: block; width: fit-content; margin-left:auto; margin-right: auto; }

        /* Utility Classes */
        .hidden { display: none; }
        .small-text { font-size: 0.8em; opacity: 0.7; margin-top: 5px; display: block; text-align: center;}

        /* Feedback Message */
        .feedback-message { position: fixed; bottom: 20px; left: 15px; transform: translateX(0); background-color: var(--primary-color); color: var(--bg-color); padding: 10px 20px; border-radius: 5px; z-index: 3000; opacity: 0; transition: opacity 0.5s ease, bottom 0.5s ease; pointer-events: none; text-align: center; max-width: calc(100% - var(--sidebar-width) - 50px); }
        .feedback-message.show { opacity: 1; bottom: 30px; }

        /* Headers */
        h2, h3 { color: var(--primary-color); border-bottom: 1px solid var(--primary-color); padding-bottom: 5px; margin-bottom: 15px; display: block; text-align: center; transition: color var(--transition-speed) ease, border-color var(--transition-speed) ease; width: fit-content; margin-left: auto; margin-right: auto; }
        #class-buttons h3 { margin-top: 20px; }

        /* Reddit Sidebar Styles */
        #reddit-sidebar { position: fixed; top: 0; right: 0; width: var(--sidebar-width); height: 100vh; background-color: var(--sidebar-bg); border-left: 1px solid var(--sidebar-border); z-index: 1500; display: flex; flex-direction: column; overflow: hidden; box-shadow: -5px 0 15px rgba(0,0,0,0.2); transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease; }
        #reddit-sidebar h3 { padding: 15px; margin: 0; border-bottom: 1px solid var(--sidebar-border); font-size: 1.1em; text-align: center; flex-shrink: 0; color: var(--primary-color); width: auto; margin-left: 0; margin-right: 0; display: block; }
        #reddit-search-area { padding: 10px 15px; border-bottom: 1px solid var(--sidebar-border); display: flex; gap: 5px; flex-shrink: 0; }
        #reddit-search-input { margin-bottom: 0; flex-grow: 1; }
        #reddit-search-btn { margin: 0; padding: 8px 12px; font-size: 0.9em; height: auto; flex-shrink: 0; cursor: pointer; }
        #reddit-posts { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .reddit-post { border-bottom: 1px solid var(--sidebar-border); padding: 10px 0; margin-bottom: 10px; }
        .reddit-post:last-child { border-bottom: none; margin-bottom: 0; }
        .reddit-post-title { font-size: 0.95em; font-weight: bold; margin-bottom: 5px; }
        .reddit-post-title span { color: var(--link-color); text-decoration: none; cursor: pointer; }
        .reddit-post-title span:hover { text-decoration: underline; }
        .reddit-post-meta { font-size: 0.8em; opacity: 0.8; }
        #reddit-status { padding: 15px; text-align: center; font-style: italic; opacity: 0.7; }

        /* Reddit Popup Modal Styles */
        .popup-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .popup-overlay.active { opacity: 1; pointer-events: auto; }
        .popup-content { background-color: var(--popup-bg); padding: 25px; border-radius: 10px; max-width: 80vw; max-height: 85vh; overflow-y: auto; position: relative; border: 2px solid var(--popup-border); box-shadow: 0 5px 25px rgba(0,0,0,0.4); transform: scale(0.9); transition: transform 0.3s ease, background-color var(--transition-speed) ease, border-color var(--transition-speed) ease; }
        .popup-overlay.active .popup-content { transform: scale(1.0); }
        .popup-close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.8em; font-weight: bold; color: var(--text-color); background: none; border: none; cursor: pointer; line-height: 1; opacity: 0.7; transition: opacity 0.2s ease; }
        .popup-close-btn:hover { opacity: 1; }
        .popup-title { font-size: 1.3em; font-weight: bold; margin-bottom: 15px; color: var(--primary-color); border-bottom: 1px solid var(--popup-border); padding-bottom: 10px; }
        .popup-body { margin-bottom: 20px; }
        .popup-body p { line-height: 1.5; margin-bottom: 1em; }
        .popup-body a { color: var(--link-color); text-decoration: underline; cursor: pointer; }
        .popup-body img, .popup-body video { max-width: 100%; height: auto; display: block; margin: 10px auto; border-radius: 5px; }
        .popup-body iframe { max-width: 100%; }
        .popup-link-original { font-size: 0.9em; display: block; margin-top: 15px; opacity: 0.8; }
        .popup-link-original a { color: var(--link-color); }

    </style>
</head>
<body>
    <!-- Custom Cursor Element -->
    <div class="crosshair"></div>

    <!-- Tab Navigation -->
    <nav class="tabs">
        <button class="tab-button" data-tab="class">🎓 Class</button>
        <button class="tab-button" data-tab="pastebin">📋 Pastebins</button>
        <button class="tab-button" data-tab="weao">🌐 Weao</button>
        <!-- Alarm Tab Button Removed -->
        <button class="tab-button" data-tab="gaming">🎮 Gaming</button>
        <button class="tab-button" id="theme-toggle">🌓 Theme</button>
    </nav>

    <!-- Main Content Area -->
    <main>
        <section id="class" class="tab-content">
            <h2>K12 Links & Classes</h2>
            <a href="https://login-learn.k12.com/#schedule" target="_blank" rel="noopener noreferrer" class="neon-btn link-btn">
                Open K12 Schedule Page ↗️
            </a>
            <div id="class-buttons" style="margin-top: 20px;">
                <h3>Class Quick Links (Play Sound)</h3>
                <div id="class-list">
                    <!-- Class buttons now trigger sound directly -->
                    <button class="neon-btn class-play-sound">
                        9:50 - 7th Math
                    </button>
                    <button class="neon-btn class-play-sound">
                        10:45 - 7th Science
                    </button>
                    <button class="neon-btn class-play-sound">
                        12:30 - 7th ELA
                    </button>
                    <!-- Add more if needed, ensure they have class="neon-btn class-play-sound" -->
                </div>
                 <span class="small-text">
                    Clicking a class plays a random sound.
                 </span>
            </div>
        </section>

        <section id="pastebin" class="tab-content">
            <h2>Pastebins</h2>
            <div id="pastebin-list-container">
                <div id="pastebin-list">
                     <p>Loading pastebin links...</p>
                </div>
            </div>
            <span class="small-text">
                Note: Shows manually configured pastes.
            </span>
            <div id="pastebin-view" class="hidden">
                 <div id="pastebin-loading" class="hidden">Loading content...</div>
                <pre id="pastebin-content"></pre>
                <button class="neon-btn" id="copy-pastebin-btn">📋 Copy</button>
                <button class="neon-btn" id="back-to-pastebin-list-btn">🔙 Back</button>
            </div>
        </section>

        <section id="weao" class="tab-content">
            <h2>Weao Mirror</h2>
            <iframe src="https://weao.xyz" id="weao-iframe" title="Weao Mirror"></iframe>
        </section>

        <!-- Alarm Tab Section Removed -->

        <section id="gaming" class="tab-content">
            <h2>Xbox Cloud Gaming</h2>
            <iframe src="https://www.xbox.com/play" title="Xbox Cloud Gaming" style="height:75vh;"></iframe>
        </section>
    </main>

    <!-- Reddit Sidebar -->
    <aside id="reddit-sidebar">
        <h3>r/k12 Feed</h3>
        <div id="reddit-search-area">
            <input type="search" id="reddit-search-input" placeholder="Search r/k12...">
            <button id="reddit-search-btn" class="neon-btn">🔎</button>
        </div>
        <div id="reddit-posts">
            <div id="reddit-status">Loading posts...</div>
        </div>
    </aside>

    <!-- Reddit Popup Modal Structure -->
     <div id="reddit-popup-overlay" class="popup-overlay">
         <div id="reddit-popup-content" class="popup-content">
             <button id="reddit-popup-close" class="popup-close-btn">×</button>
             <div id="reddit-popup-title" class="popup-title">Post Title</div>
             <div id="reddit-popup-body" class="popup-body"></div>
             <div class="popup-link-original">
                 <a id="reddit-popup-original-link" href="#" target="_blank" rel="noopener noreferrer">View Original Post on Reddit ↗️</a>
             </div>
         </div>
     </div>

    <!-- Feedback Message Area -->
    <div id="feedback" class="feedback-message"></div>

    <!-- Hidden Audio Elements for Class Sounds -->
    <audio id="class-sound1" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>
    <audio id="class-sound2" src="https://www.soundjay.com/buttons/sounds/beep-10.mp3" preload="auto"></audio>
    <!-- Add more <audio> elements here if you want more sounds -->

    <script>
        // --- Configuration ---
        const THEME_KEY = 'dashboard_theme';
        const DEFAULT_THEME = 'dark-theme';
        const PASTEBIN_LINKS = [
            { name: 'Example Script 1', url: 'https://pastebin.com/raw/MfSLGYzP' },
            { name: 'Example Script 2', url: 'https://pastebin.com/raw/gZDbqP4G' },
            // { name: 'My Script Name', url: 'https://pastebin.com/raw/YOUR_ID' }
        ];

        // --- State Variables ---
        // isAlarmFeatureEnabled removed

        // --- DOM Elements ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const themeToggleButton = document.getElementById('theme-toggle');
        const body = document.body;
        const feedbackElement = document.getElementById('feedback');
        const crosshair = document.querySelector('.crosshair');
        const pastebinListDiv = document.getElementById('pastebin-list');
        const pastebinViewDiv = document.getElementById('pastebin-view');
        const pastebinContentPre = document.getElementById('pastebin-content');
        const pastebinLoadingDiv = document.getElementById('pastebin-loading');
        const copyPastebinBtn = document.getElementById('copy-pastebin-btn');
        const backToPastebinListBtn = document.getElementById('back-to-pastebin-list-btn');
        // playAlarmBtn removed
        const classSounds = [ document.getElementById('class-sound1'), document.getElementById('class-sound2') ]; // Renamed
        const weaoIframe = document.getElementById('weao-iframe');
        const redditPostsDiv = document.getElementById('reddit-posts');
        const redditSearchInput = document.getElementById('reddit-search-input');
        const redditSearchBtn = document.getElementById('reddit-search-btn');
        const popupOverlay = document.getElementById('reddit-popup-overlay');
        const popupContent = document.getElementById('reddit-popup-content');
        const popupCloseBtn = document.getElementById('reddit-popup-close');
        const popupTitle = document.getElementById('reddit-popup-title');
        const popupBody = document.getElementById('reddit-popup-body');
        const popupOriginalLink = document.getElementById('reddit-popup-original-link');
        const classPlaySoundButtons = document.querySelectorAll('.class-play-sound'); // Select class buttons

        // --- Functions ---

        /** Shows a specific tab and hides others. */
        function showTab(tabId) {
            tabContents.forEach(content => content.classList.remove('active'));
            tabButtons.forEach(button => button.classList.remove('active'));
            const activeContent = document.getElementById(tabId);
            const activeButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (activeContent) activeContent.classList.add('active');
            if (activeButton) activeButton.classList.add('active');
            try { window.location.hash = tabId; } catch(e) {}
        }

        /** Sets the theme on the body and saves preference. */
        function setTheme(themeName) {
            body.className = ''; body.classList.add(themeName); localStorage.setItem(THEME_KEY, themeName);
            updateThemeToggleButton(themeName); setPrimaryColorRGB(themeName); sendThemeToIframe(themeName);
        }

        /** Helper to set RGB version of primary color for effects like inset shadow */
        function setPrimaryColorRGB(themeName) {
            try {
                const style = getComputedStyle(document.documentElement);
                const primaryColorHex = style.getPropertyValue(themeName === 'dark-theme' ? '--primary-color-dark' : '--primary-color-light').trim();
                let r = 0, g = 0, b = 0;
                if (primaryColorHex.startsWith('#')) {
                    const hex = primaryColorHex.substring(1);
                    if (hex.length === 6) { r = parseInt(hex.substring(0, 2), 16); g = parseInt(hex.substring(2, 4), 16); b = parseInt(hex.substring(4, 6), 16); }
                    else if (hex.length === 3) { r = parseInt(hex[0] + hex[0], 16); g = parseInt(hex[1] + hex[1], 16); b = parseInt(hex[2] + hex[2], 16); }
                }
                document.documentElement.style.setProperty('--primary-color-rgb', `${r}, ${g}, ${b}`);
            } catch (e) { console.error("Error setting primary color RGB:", e); document.documentElement.style.setProperty('--primary-color-rgb', `255, 0, 0`); }
        }

        /** Toggles between dark and light themes. */
        function toggleTheme() {
            const currentTheme = localStorage.getItem(THEME_KEY) || DEFAULT_THEME;
            const newTheme = currentTheme === 'dark-theme' ? 'light-theme' : 'dark-theme';
            setTheme(newTheme);
        }

        /** Updates the theme toggle button text/icon. */
        function updateThemeToggleButton(themeName) {
            if(themeToggleButton) themeToggleButton.textContent = themeName === 'dark-theme' ? '☀️ Light' : '🌙 Dark';
        }

        /** Populates the list of Pastebin buttons. */
        function loadPastebinButtons() {
            if (!pastebinListDiv) return; pastebinListDiv.innerHTML = '';
            if (PASTEBIN_LINKS.length === 0) { pastebinListDiv.innerHTML = '<p>No Pastebin links configured.</p>'; return; }
            PASTEBIN_LINKS.forEach(paste => {
                const btn = document.createElement('button'); btn.textContent = paste.name; btn.classList.add('neon-btn');
                btn.addEventListener('click', () => loadPastebinContent(paste.url)); pastebinListDiv.appendChild(btn);
            });
        }

        /** Fetches and displays content from a Pastebin raw URL. */
        async function loadPastebinContent(url) {
            const listContainer = document.getElementById('pastebin-list-container'); if (listContainer) listContainer.classList.add('hidden');
            if(pastebinViewDiv) pastebinViewDiv.classList.remove('hidden'); if(pastebinContentPre) pastebinContentPre.textContent = '';
            if(pastebinLoadingDiv) pastebinLoadingDiv.classList.remove('hidden');
            try { const response = await fetch(url); if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`); const data = await response.text(); if(pastebinContentPre) pastebinContentPre.textContent = data; }
            catch (error) { console.error("Failed load Pastebin:", error); if(pastebinContentPre) pastebinContentPre.textContent = `Error: ${error.message}`; showFeedback(`Failed load pastebin: ${error.message}`, "error"); }
            finally { if(pastebinLoadingDiv) pastebinLoadingDiv.classList.add('hidden'); }
        }

        /** Copies the displayed Pastebin content to the clipboard. */
        function copyPastebinContent() {
            const text = pastebinContentPre?.textContent; if (navigator.clipboard && text) { navigator.clipboard.writeText(text) .then(() => showFeedback("Copied!")) .catch(err => showFeedback("Copy failed.", "error")); } else if (text) { showFeedback("Clipboard API not available.", "error"); } else { showFeedback("Nothing to copy.", "error"); }
        }

        /** Hides the Pastebin content view and shows the list container. */
        function showPastebinListView() { if(pastebinViewDiv) pastebinViewDiv.classList.add('hidden'); const listContainer = document.getElementById('pastebin-list-container'); if (listContainer) listContainer.classList.remove('hidden'); }

        // updateAlarmUI removed
        // toggleAlarmFeature removed

        /** Plays a random sound from the class sound list */
        function playRandomClassSound() {
            if (classSounds.length > 0) {
                // Stop any currently playing sound first
                classSounds.forEach(sound => { if(sound) sound.pause(); });

                // Select and play a random sound
                const sound = classSounds[Math.floor(Math.random() * classSounds.length)];
                if(sound) {
                    sound.currentTime = 0; // Rewind to start
                    sound.play().catch(e => {
                        console.error("Audio play failed:", e);
                        showFeedback("Could not play sound.", "error");
                    });
                } else {
                     console.warn("Selected sound element is invalid.");
                     showFeedback("Could not play sound.", "error");
                }
            } else {
                showFeedback("No class sounds available.", "error");
            }
        }

        /** Shows a temporary feedback message. */
        let feedbackTimeout;
        function showFeedback(message, type = "info") {
            if (!feedbackElement) return; clearTimeout(feedbackTimeout);
            feedbackElement.textContent = message; feedbackElement.className = 'feedback-message';
            feedbackElement.style.backgroundColor = type === 'error' ? '#800' : 'var(--primary-color)';
            feedbackElement.style.color = type === 'error' ? 'white' : 'var(--bg-color)';
            feedbackElement.classList.add('show');
            feedbackTimeout = setTimeout(() => feedbackElement.classList.remove('show'), 3000);
        }

        /** Sends the current theme information to the Weao iframe */
        function sendThemeToIframe(themeName) { if (weaoIframe?.contentWindow) { setTimeout(() => { try { weaoIframe.contentWindow.postMessage({ dashboardTheme: themeName }, 'https://weao.xyz'); } catch (e) {} }, 150); } }

        /** Decodes HTML entities in a string */
         function decodeHtmlEntities(text) { if (!text) return ''; const textarea = document.createElement('textarea'); textarea.innerHTML = text; return textarea.value; }

        // --- Reddit Sidebar Functions ---
        function setRedditStatus(message, isError = false) { if(!redditPostsDiv) return; redditPostsDiv.innerHTML = ''; const statusDiv = document.createElement('div'); statusDiv.id = 'reddit-status'; statusDiv.textContent = message; if (isError) statusDiv.style.color = 'red'; redditPostsDiv.appendChild(statusDiv); }
        async function fetchRedditPosts(query = null) {
            if(!redditPostsDiv) { console.warn("Reddit posts container not found."); return; } setRedditStatus('Loading posts...'); let url = 'https://www.reddit.com/r/k12/.json?limit=25&raw_json=1'; if (query) url = `https://www.reddit.com/r/k12/search.json?q=${encodeURIComponent(query)}&restrict_sr=on&limit=25&sort=relevance&t=all&raw_json=1`;
            try { const response = await fetch(url, { mode: 'cors', headers: { 'Accept': 'application/json' } }); if (!response.ok) throw new Error(`Reddit API Error: ${response.status} ${response.statusText}. CORS policy may be preventing access.`); const data = await response.json(); if (!data?.data?.children?.length) { setRedditStatus(query ? 'No results found.' : 'No posts found or unable to load.'); return; }
                redditPostsDiv.innerHTML = ''; data.data.children.forEach(child => { const post = child.data; if (!post || post.stickied) return; const postDiv = document.createElement('div'); postDiv.classList.add('reddit-post'); const titleDiv = document.createElement('div'); titleDiv.classList.add('reddit-post-title'); const titleSpan = document.createElement('span'); titleSpan.textContent = decodeHtmlEntities(post.title); titleSpan.title = "Click to view post details"; titleSpan.addEventListener('click', () => showRedditPopup(post)); titleDiv.appendChild(titleSpan); const metaDiv = document.createElement('div'); metaDiv.classList.add('reddit-post-meta'); const postDate = new Date(post.created_utc * 1000); metaDiv.textContent = `by ${post.author} | ${post.score} points | ${postDate.toLocaleDateString()}`; postDiv.appendChild(titleDiv); postDiv.appendChild(metaDiv); redditPostsDiv.appendChild(postDiv); });
            } catch (error) { console.error("Error fetching Reddit posts:", error); setRedditStatus(`Error: ${error.message}. Check browser console for details.`, true); }
        }

         // --- Reddit Popup Functions ---
        function hideRedditPopup() { if(popupOverlay) popupOverlay.classList.remove('active'); }
        function showRedditPopup(post) {
            if(!popupOverlay || !popupTitle || !popupBody || !popupOriginalLink || !post) return; popupTitle.textContent = decodeHtmlEntities(post.title); popupBody.innerHTML = ''; const postHint = post.post_hint; const url = post.url_overridden_by_dest || post.url;
             if (post.selftext_html) { popupBody.innerHTML = decodeHtmlEntities(post.selftext_html); } // CAUTION: XSS risk
            else if (postHint === 'image' || /\.(jpg|jpeg|png|gif)$/i.test(url)) { const img = document.createElement('img'); img.src = url; img.alt = decodeHtmlEntities(post.title); popupBody.appendChild(img); }
            else if (postHint === 'hosted:video' && post.media?.reddit_video?.fallback_url) { const video = document.createElement('video'); video.src = post.media.reddit_video.fallback_url; video.controls = true; video.muted = true; popupBody.appendChild(video); }
            else if (postHint === 'rich:video' && post.media?.oembed?.html) { const embedHtml = decodeHtmlEntities(post.media.oembed.html); const tempDiv = document.createElement('div'); tempDiv.innerHTML = embedHtml; while (tempDiv.firstChild) { popupBody.appendChild(tempDiv.firstChild); } }
            else if (postHint === 'link' || (url && url !== `https://www.reddit.com${post.permalink}`)) { const linkPara = document.createElement('p'); linkPara.textContent = "Links to: "; const link = document.createElement('a'); link.href = url; link.target = '_blank'; link.rel = 'noopener noreferrer'; link.textContent = url; linkPara.appendChild(link); popupBody.appendChild(linkPara); }
            else { popupBody.innerHTML = '<p><i>No text content or preview available. View original post for details.</i></p>'; }
            popupOriginalLink.href = `https://www.reddit.com${post.permalink}`; popupOverlay.classList.add('active');
        }

        // --- Initialization & Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem(THEME_KEY) || DEFAULT_THEME; setTheme(savedTheme);
            loadPastebinButtons(); fetchRedditPosts();
            let initialTab = ''; try { initialTab = window.location.hash.substring(1); } catch(e) {}
            const validTabs = Array.from(tabButtons).map(btn => btn.dataset.tab); if (!initialTab || !validTabs.includes(initialTab)) initialTab = tabButtons[0]?.dataset.tab || 'class'; showTab(initialTab);
            // updateAlarmUI removed

            // --- Event Listeners ---
            tabButtons.forEach(button => { button.addEventListener('click', () => showTab(button.dataset.tab)); });
            if(themeToggleButton) themeToggleButton.addEventListener('click', toggleTheme);

            document.addEventListener('mousemove', (e) => { if (crosshair) { crosshair.style.left = `${e.clientX}px`; crosshair.style.top = `${e.clientY}px`; const cs = window.getComputedStyle(crosshair); if (cs.opacity === '0') crosshair.style.opacity = '1'; } });
            document.addEventListener('mouseleave', () => { if (crosshair) crosshair.style.opacity = '0'; });

            if (copyPastebinBtn) copyPastebinBtn.addEventListener('click', copyPastebinContent);
            if (backToPastebinListBtn) backToPastebinListBtn.addEventListener('click', showPastebinListView);
            // playAlarmBtn listener removed

            // Class Buttons - Add listeners to PLAY sound directly
            classPlaySoundButtons.forEach(button => {
                button.addEventListener('click', playRandomClassSound); // Changed listener
            });

            if (redditSearchBtn && redditSearchInput) { const triggerSearch = () => fetchRedditPosts(redditSearchInput.value.trim() || null); redditSearchBtn.addEventListener('click', triggerSearch); redditSearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') triggerSearch(); }); }
            if (popupCloseBtn) popupCloseBtn.addEventListener('click', hideRedditPopup);
            if (popupOverlay) popupOverlay.addEventListener('click', (event) => { if (event.target === popupOverlay) hideRedditPopup(); });
            if (weaoIframe) { const sendInitialTheme = () => sendThemeToIframe(localStorage.getItem(THEME_KEY) || DEFAULT_THEME); weaoIframe.addEventListener('load', () => setTimeout(sendInitialTheme, 200)); sendInitialTheme(); }
        });
    </script>
</body>
</html>
